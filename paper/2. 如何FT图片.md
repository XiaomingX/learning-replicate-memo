**如何微调图像模型**

**目录**
1. 简介
2. 准备工作
3. 第一步：收集训练图像
4. 第二步：选择一个独特的触发词
5. 第三步：创建和训练模型
6. 第四步：生成图像
7. 第五步：使用API生成图像
8. 第六步：使用语言模型优化提示词

---

### **1. 简介**
FLUX.1 系列图像生成模型可以生成比开源模型更高质量的图像。默认的 FLUX 模型可以生成人物、风景和物体的精美图像，但您也可以通过微调 FLUX 模型来生成特定风格、特定主题的图像，比如生成您自己、宠物或特定物体的图像。

在 Replicate 平台上微调 FLUX 模型非常简单，您只需要准备几张图片即可开始，无需深厚的技术背景。整个过程都可以在网页上完成，无需编写一行代码。社区中已经有成百上千个公开和私人定制的 FLUX 微调模型可供参考。

---

### **2. 准备工作**
要开始微调 FLUX 模型，您需要准备：
- 一个 Replicate 账户
- 一些用于训练的图像
- 2 至 3 美元的费用

---

### **3. 第一步：收集训练图像**
您需要收集一些用于训练的图片，这些图片应尽可能多样化，确保包括不同的拍摄角度和光线条件。

#### **图像收集的关键要点**
- 图像格式：支持 WebP、JPG 和 PNG 格式。
- 分辨率：尽可能使用 1024x1024 或更高的分辨率。
- 文件名：无特定要求，可随意命名。
- 图像比例：无特定要求，方形、横向、纵向均可。
- 图片数量：建议至少 10 张图像。
- 多样性：图像应在不同的场景、服装、光线和角度下拍摄。

将这些图像放入一个名为 `data` 的文件夹中，然后将其压缩成一个 `data.zip` 文件。使用以下命令压缩文件：
```bash
zip -r data.zip data
```

---

### **4. 第二步：选择一个独特的触发词**
在微调图像模型时，您需要创建一个“触发词”，当生成图像时可在提示中使用它来激活训练的概念。

#### **如何选择触发词？**
- 选择一个独特的词汇，如 `MY_UNIQ_TRGGR`，类似个性化的车牌号，但不限制长度。
- 不要使用常见的单词（如“dog”或“cyberpunk”），以免与现有的模型冲突。
- 不要使用 `TOK`，因为这可能会与其他微调模型冲突。
- 大小写不敏感，但使用大写字母可使其在提示词中更醒目。

示例：选择 `ZIKI` 作为触发词。这个词短小、独特且易记。

---

### **5. 第三步：创建和训练模型**
您可以通过网页表单或 API 来微调 FLUX 模型。这次我们使用网页表单的方式，操作更简单。

#### **创建和训练模型的步骤**
1. 访问 [replicate.com/ostris/flux-dev-lora-trainer](https://replicate.com/ostris/flux-dev-lora-trainer)。
2. 选择一个用于发布的模型，可以是现有模型，也可以是新模型。
3. 将 `data.zip` 文件拖拽到输入区域中上传图像。
4. 在 `trigger_word` 输入框中输入之前选择的触发词（例如 `ZIKI`）。
5. 训练步骤数量选择 1000，确保模型有足够的时间学习概念。更多的步骤可能会增加费用，但效果的提升不明显。
6. 其余的输入框保持默认值，点击“Create training”按钮开始训练。

**费用说明**
- 训练使用 Nvidia H100 GPU，费用为每秒 $0.001528。
- 典型的 20 分钟训练（使用约 20 张图片和 1000 步）大约花费 $1.85 美元。

---

### **6. 第四步：生成图像**
训练大约需要 20 分钟，您可以利用这段时间起身活动一下，放松身心。返回后，您的模型将准备就绪，您可以直接在网页上生成图像。

#### **生成图像的操作步骤**
1. 访问 Replicate 的在线操作平台，选择您的模型。
2. 在提示词中输入描述性语言，并包含触发词（例如 `ZIKI`）。
3. 点击“生成”按钮，等待图像生成。FLUX 模型可以理解长提示词，因此提示越详细，结果越理想。

---

### **7. 第五步：使用API生成图像**
除了在网页上点击按钮生成图像，您还可以使用 API 从代码中调用您的模型。

#### **使用 Node.js 调用 API 的示例代码**
```javascript
import Replicate from "replicate";
const replicate = new Replicate();
const model = "zeke/ziki-flux:dadc276a9062240e68f110ca06521752f334777a94f031feb0ae78ae3edca58e";
const prompt = "ZIKI，一个成年男性，站在黎明时分的珠穆朗玛峰山顶...";
const output = await replicate.run(model, { input: { prompt } });

// 保存生成的图像
import { writeFile } from "node:fs/promises";
await writeFile("./output.png", output);
```

---

### **8. 第六步：使用语言模型优化提示词**
创建详细的提示词可能会很困难，使用简单的提示（如“ZIKI穿着高领毛衣”）生成的图像通常不够理想。语言模型可以帮助生成更加多样化和有趣的提示。

#### **提示词示例**
1. ZIKI，一位 40 多岁的男性街头艺术家，正在城市墙上喷涂生动的壁画，脸上带着专注的表情，头上戴着毛线帽。
2. ZIKI，一位在蒙特卡洛赌场玩扑克的优雅绅士特工，他穿着量身定制的晚礼服，手里拿着一杯马提尼酒。
3. ZIKI，一位 40 多岁指挥交响乐团的指挥家，穿着无尾礼服，挥舞着指挥棒，面露深度专注的表情。

#### **使用语言模型生成提示词的示例代码**
```javascript
import Replicate from "replicate";
const replicate = new Replicate();
const model = "meta/meta-llama-3.1-405b-instruct";
const prompt = "为图像生成模型编写 10 个提示词...";
const output = await replicate.run(model, { input: { prompt } });
console.log(output);
```

